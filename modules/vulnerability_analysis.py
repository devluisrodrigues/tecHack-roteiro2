# A análise de vulnerabilidade será implementada com base na versão do Nmap
from config import GREEN, RESET, YELLOW
import nmap
import socket

def vulnerability_analysis():
    """
    Função para realizar uma análise de vulnerabilidade em um host específico.
    """
    print("Iniciando a análise de vulnerabilidade...\n")
    
    host = input("Digite o endereço IP ou nome do host: ")
    
    try:
        ip = socket.gethostbyname(host)
        if ip != host:
            print(f"{YELLOW}Host convertido para IP: {ip}{RESET}")
    except socket.gaierror:
        print(f"{YELLOW}Erro: Host não encontrado, tente digitar o ip.{RESET}")
        return
    
    nm = nmap.PortScanner()
    
    nm.scan(ip, arguments='--script vuln -d')
    
    # Resultados
    for host in nm.all_hosts():
        print(f"{GREEN}Host: {host} ({nm[host].hostname()}){RESET}")
        print(f"{GREEN}Estado: {nm[host].state()}{RESET}")

        for proto in nm[host].all_protocols():
            print(f"{GREEN}Protocolo: {proto}{RESET}")
            
            lport = sorted(nm[host][proto].keys())
            
            for port in lport:
                print(f"{GREEN}Porta: {port}\tEstado: {nm[host][proto][port]['state']}{RESET}")
                if 'script' in nm[host][proto][port]:
                    print(f"{GREEN}Resultados:{RESET}")
                    for script, output in nm[host][proto][port]['script'].items():
                        # Divide o print in alguns cenários possíveis para limpar o terminal de resposta:
                        if "Missing required script args" in output or "not supported" in output:
                            print(f"O Módulo {script} não é suportado para este host.")
                        elif "Couldn't find" in output:
                            print(f"{YELLOW}[Nenhuma vulnerabilidade] {script}:{RESET} {output}")
                        elif "ERROR" in output:
                            print(f"{YELLOW}[Erro] {script}:{RESET} {output}")
                        else:
                            print(f"{GREEN}[VULNERABILIDADE] {script}:{RESET}\n{output}")